<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mara's Tritone Picture Colorizer</title>
  <style>
    body { font-family: monospace; background:#0a0a0a; color:#f0f0f0; display:grid; place-items:center; height:100vh; margin:0; }
    .app { width:min(960px,100%); background:#111; border:2px solid #444; border-radius:8px; padding:20px; box-shadow:0 0 30px rgba(0,0,0,0.9); }
    h1 { font-size:22px; margin:0 0 12px; text-align:center; letter-spacing:2px; }
    .controls { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; margin: 8px 0 8px; }
    .ctrl { background:#1b1b1b; border:1px solid #333; border-radius:6px; padding:10px; }
    .ctrl label { display:flex; justify-content:space-between; align-items:center; font-size:12px; color:#c9c9c9; margin-bottom:6px; }
    .ctrl input[type="range"] { width:100%; }
    .dropzone { border:3px dashed #888; border-radius:6px; padding:16px; text-align:center; cursor:pointer; margin:10px 0; background:#1b1b1b; }
    .dropzone.dragover { border-color:#ff3b8d; background:#222; }
    .top-row { display:flex; justify-content:space-between; gap:10px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
    .palette { font-size:11px; color:#bbb; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .preset { background:#333; border:1px solid #555; padding:8px 10px; border-radius:6px; color:#fff; font-weight:bold; cursor:pointer; }
    canvas { max-width:100%; height:auto; display:block; margin:0 auto; background:#000; }
    button { background:#ff3b8d; border:none; padding:10px 16px; border-radius:6px; color:#fff; font-weight:bold; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    @media (max-width: 820px){ .controls{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Mara's Tritone Picture Colorizer">
    <h1>Mara's Tritone Picture Colorizer</h1>

    <div class="top-row">
      <div class="palette" id="paletteLabel">Palette: —</div>
      <div class="actions">
        <button class="preset" id="presetSoft">Soft</button>
        <button class="preset" id="presetNormal">Normal</button>
        <button class="preset" id="presetBrutal">Brutal</button>
        <button id="randomize">Randomize Colors</button>
        <button id="downloadTop" disabled>Download PNG</button>
      </div>
    </div>

    <div class="controls" aria-label="Effect Controls">
      <div class="ctrl">
        <label for="grain">Grain / Noise <span id="grainVal">5</span></label>
        <input id="grain" type="range" min="0" max="10" value="5" />
      </div>
      <div class="ctrl">
        <label for="thresh">Threshold (contrast) <span id="threshVal">5</span></label>
        <input id="thresh" type="range" min="0" max="10" value="5" />
      </div>
      <div class="ctrl">
        <label for="blend">Blend (mapped %) <span id="blendVal">90%</span></label>
        <input id="blend" type="range" min="50" max="100" value="90" />
      </div>
    </div>

    <div id="drop" class="dropzone" tabindex="0">Drop image here or click to select</div>
    <input id="file" type="file" accept="image/*" hidden />

    <canvas id="canvas" aria-label="Output canvas"></canvas>
    <div style="display:flex;justify-content:center;margin-top:8px"><button id="download" disabled>Download PNG</button></div>
  </div>

  <script>
    const drop = document.getElementById('drop');
    const fileInput = document.getElementById('file');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const downloadBtn = document.getElementById('download');
    const downloadTopBtn = document.getElementById('downloadTop');
    const randomizeBtn = document.getElementById('randomize');
    const paletteLabel = document.getElementById('paletteLabel');

    const presetSoft = document.getElementById('presetSoft');
    const presetNormal = document.getElementById('presetNormal');
    const presetBrutal = document.getElementById('presetBrutal');

    const grain = document.getElementById('grain');
    const thresh = document.getElementById('thresh');
    const blend = document.getElementById('blend');
    const grainVal = document.getElementById('grainVal');
    const threshVal = document.getElementById('threshVal');
    const blendVal = document.getElementById('blendVal');

    let originalFileName = 'image';

    // ------- Palette
    function hexToRgb(hex){
      const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return m ? {r:parseInt(m[1],16), g:parseInt(m[2],16), b:parseInt(m[3],16)} : {r:0,g:0,b:0};
    }
    const BASE = [
      { name:'Resistance Blue', c: hexToRgb('#000072') },
      { name:'Hero Green',      c: hexToRgb('#1b602f') },
      { name:'Brave Pink',      c: hexToRgb('#f784c5') }
    ];
    let COLORS = [...BASE];
    function shufflePalette(){
      COLORS = [...BASE]
        .map(v => ({...v, sort: Math.random()}))
        .sort((a,b)=>a.sort-b.sort)
        .map(({name,c})=>({name,c}));
      paletteLabel.textContent = `Palette: ${COLORS[0].name} → ${COLORS[1].name} → ${COLORS[2].name}`;
    }

    let srcData = null;
    let srcW = 0, srcH = 0;

    function toLuminance(r,g,b){ return 0.2126*r + 0.7152*g + 0.0722*b; }
    function applyContrast01(x, factor){ return Math.min(1, Math.max(0, 0.5 + (x - 0.5) * factor )); }

    function renderFromSource(){
      if (!srcData) return;
      const out = ctx.createImageData(srcW, srcH);
      const s = srcData.data;
      const d = out.data;

      const contrastFactor = 1 + Number(thresh.value) * 0.1;
      const gAmt = Number(grain.value);
      const mappedPct = Number(blend.value) / 100;
      const origPct = 1 - mappedPct;
      const cut1 = 1/3, cut2 = 2/3;

      const ditherAmp = (gAmt / 10) * 0.25;

      for (let i = 0; i < s.length; i += 4) {
        let y = toLuminance(s[i], s[i+1], s[i+2]) / 255;
        if (ditherAmp > 0) y = Math.min(1, Math.max(0, y + (Math.random()-0.5)*2*ditherAmp));
        y = applyContrast01(y, contrastFactor);

        let mapped;
        if (y < cut1) mapped = COLORS[0].c;
        else if (y < cut2) mapped = COLORS[1].c;
        else mapped = COLORS[2].c;

        const r = Math.round(mapped.r * mappedPct + s[i]   * origPct);
        const g = Math.round(mapped.g * mappedPct + s[i+1] * origPct);
        const b = Math.round(mapped.b * mappedPct + s[i+2] * origPct);

        d[i] = r; d[i+1] = g; d[i+2] = b; d[i+3] = 255;
      }

      canvas.width = srcW;
      canvas.height = srcH;
      ctx.putImageData(out,0,0);
      downloadBtn.disabled = false;
      downloadTopBtn.disabled = false;
    }

    function loadFile(file){
      originalFileName = file.name.split('.')[0];
      const img = new Image();
      img.onload = ()=>{
        grain.value = 5; grainVal.textContent = '5';
        thresh.value = 5; threshVal.textContent = '5';
        blend.value = 90; blendVal.textContent = '90%';

        srcW = img.naturalWidth; srcH = img.naturalHeight;
        canvas.width = srcW; canvas.height = srcH;
        ctx.drawImage(img,0,0);
        srcData = ctx.getImageData(0,0,srcW,srcH);

        COLORS = [...BASE];
        paletteLabel.textContent = `Palette: ${COLORS[0].name} → ${COLORS[1].name} → ${COLORS[2].name}`;
        renderFromSource();
      };
      img.onerror = ()=>alert('Could not load that file. Try a different image.');
      img.src = URL.createObjectURL(file);
    }

    drop.addEventListener('click',()=>fileInput.click());
    drop.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' ') fileInput.click(); });
    drop.addEventListener('dragover',e=>{ e.preventDefault(); drop.classList.add('dragover'); });
    drop.addEventListener('dragleave',()=>drop.classList.remove('dragover'));
    drop.addEventListener('drop',e=>{ e.preventDefault(); drop.classList.remove('dragover'); if(e.dataTransfer.files.length) loadFile(e.dataTransfer.files[0]); });
    fileInput.addEventListener('change',()=>{ if(fileInput.files.length) loadFile(fileInput.files[0]); });

    function triggerDownload(){
      const a=document.createElement('a');
      a.download = `${originalFileName}_tricolorized.png`;
      a.href=canvas.toDataURL('image/png');
      a.click();
    }
    downloadBtn.addEventListener('click',triggerDownload);
    downloadTopBtn.addEventListener('click',triggerDownload);

    grain.addEventListener('input',()=>{ grainVal.textContent=grain.value; renderFromSource(); });
    thresh.addEventListener('input',()=>{ threshVal.textContent=thresh.value; renderFromSource(); });
    blend.addEventListener('input',()=>{ blendVal.textContent=`${blend.value}%`; renderFromSource(); });

    randomizeBtn.addEventListener('click',()=>{ shufflePalette(); renderFromSource(); });

    function setPreset(g,t,b){
      grain.value=g; grainVal.textContent=g;
      thresh.value=t; threshVal.textContent=t;
      blend.value=b; blendVal.textContent=`${b}%`;
      renderFromSource();
    }
    presetSoft.addEventListener('click',()=> setPreset(2,2,65));
    presetNormal.addEventListener('click',()=> setPreset(5,5,90));
    presetBrutal.addEventListener('click',()=> setPreset(10,10,100));

    blendVal.textContent=`${blend.value}%`;
    COLORS=[...BASE];
    paletteLabel.textContent=`Palette: ${COLORS[0].name} → ${COLORS[1].name} → ${COLORS[2].name}`;
  </script>
</body>
</html>
